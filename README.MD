# LANCast - Chat de voz LAN con mÃºsica compartida

**Tipo:** App mÃ³vil multiplataforma (Android / iOS)  
**Stack:** Flutter (UI + lÃ³gica de control) + C++ (nÃºcleo de audio y red)  
**Modo:** 100 % offline (LAN o hotspot)  
**Objetivo:** Chat de voz local con canal compartido de mÃºsica donde cualquiera puede ser el DJ

---

## ARQUITECTURA GENERAL

### Flutter (Dart)
```

â”œâ”€ UI/UX (Sliders, botones, chat)
â”œâ”€ Gestor de usuarios y roles (host, DJ)
â”œâ”€ Descubrimiento de peers (mDNS/UDP)
â””â”€ Control de volÃºmenes y estados
ðŸ”» FFI bridge (Flutter â†” C++)

```

### Core nativo (C++ Engine)
```

â”œâ”€ Captura de micrÃ³fono (PortAudio)
â”œâ”€ ReproducciÃ³n de audio (PortAudio)
â”œâ”€ Mezclador de fuentes (voz + mÃºsica)
â”œâ”€ Codificador Opus
â”œâ”€ EnvÃ­o de paquetes (UDP multicast)
â”œâ”€ RecepciÃ³n y decodificaciÃ³n (Opus)
â””â”€ Mixer local por usuario (volÃºmenes)

````

---

## MÃ“DULOS PRINCIPALES

### 1. Core de Audio (C++)
- Captura micrÃ³fono, reproduce audio, mezcla voz + mÃºsica  
- Codifica/decodifica con Opus  
- Usa UDP multicast (239.255.x.x) para broadcast LAN  
**LibrerÃ­as:** PortAudio, libopus, asio, libsndfile

### 2. Gestor de Red LAN
- Descubre peers vÃ­a mDNS o broadcast UDP  
- Mantiene tabla de peers activos  
- Establece conexiÃ³n directa (por IP local)

### 3. Roles del canal
- **Speaker:** voz  
- **Listener:** solo escucha  
- **DJ:** transmite mÃºsica local  

**Mensajes JSON:**
```json
{
  "type": "role_change",
  "from": "andres",
  "new_role": "dj"
}
````

### 4. Mixer local (C++)

* Mezcla canales independientes (voz/mÃºsica)
* Control individual de volumen desde Flutter

**Ejemplo Dart:**

```dart
AudioEngine.setVolume(peerId: 'andres', volume: 0.6);
```

### 5. UI/UX (Flutter)

* Pantalla principal (usuarios y roles)
* Panel de volumen
* BotÃ³n DJ
* Estado de conexiÃ³n LAN

**Paquetes:** udp_socket, multicast_dns, ffi, riverpod

### 6. SincronizaciÃ³n de mÃºsica

* Opcional: sincronizar timestamps o transmitir directamente como canal de audio

---

## FLUJO DE OPERACIÃ“N

1. **Inicio**

   * App lanza broadcast UDP anunciando canal LANCast
   * Muestra peers conectados

2. **ConexiÃ³n**

   * Todos escuchan canal multicast (239.255.42.69:5000)

3. **TransmisiÃ³n**

   * Voz: envÃ­a paquetes Opus
   * MÃºsica: canal separado (239.255.42.70)

4. **RecepciÃ³n**

   * Mezclador combina streams y ajusta volÃºmenes

5. **Cambio de DJ**

   * Nuevo DJ notifica con paquete control JSON

---

## FORMATO DE PAQUETES UDP

**Audio packet:**

```json
{
  "type": "audio",
  "peer_id": "andres",
  "stream": "voice",
  "seq": 1223,
  "timestamp": 169705920,
  "data": "<bytes opus>"
}
```

**Control packet:**

```json
{
  "type": "control",
  "action": "role_change",
  "peer_id": "carlos",
  "role": "dj"
}
```

---

## BLUEPRINT DEL PROYECTO

```
lancast/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ main.dart
â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”œâ”€â”€ home_screen.dart
â”‚   â”‚   â”œâ”€â”€ volume_panel.dart
â”‚   â”‚   â””â”€â”€ peer_list.dart
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ network_service.dart
â”‚   â”‚   â”œâ”€â”€ audio_service.dart
â”‚   â”‚   â””â”€â”€ control_service.dart
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ peer.dart
â”‚   â”‚   â”œâ”€â”€ roles.dart
â”‚   â”‚   â””â”€â”€ message.dart
â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â””â”€â”€ app_state.dart
â”‚   â””â”€â”€ ffi/
â”‚       â”œâ”€â”€ audio_bridge.dart
â”‚       â””â”€â”€ network_bridge.dart
â”‚
â”œâ”€â”€ native/
â”‚   â”œâ”€â”€ CMakeLists.txt
â”‚   â”œâ”€â”€ include/
â”‚   â”‚   â”œâ”€â”€ audio_engine.h
â”‚   â”‚   â”œâ”€â”€ network_manager.h
â”‚   â”‚   â””â”€â”€ mixer.h
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ audio_engine.cpp
â”‚   â”‚   â”œâ”€â”€ network_manager.cpp
â”‚   â”‚   â””â”€â”€ mixer.cpp
â”‚   â””â”€â”€ third_party/
â”‚       â”œâ”€â”€ portaudio/
â”‚       â”œâ”€â”€ opus/
â”‚       â””â”€â”€ asio/
â”‚
â”œâ”€â”€ assets/
â”‚   â””â”€â”€ icons/
â”‚
â””â”€â”€ pubspec.yaml
```

---

## STACK RESUMIDO

**UI:** Flutter
**LÃ³gica:** Dart
**Audio Engine:** C++ (PortAudio + Opus)
**Red LAN:** UDP multicast / mDNS
**Bridge:** FFI (Dart â†” C++)
